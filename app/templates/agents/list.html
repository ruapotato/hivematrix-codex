<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agents - Codex</title>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
    <div class="card">
        <div class="card__header">
            <h1 class="card__title">Agent Management</h1>
            <div class="card__header-actions">
                <button class="btn" onclick="window.location.href='{{ url_for('index') }}'">
                    <span class="btn__label">
                        <i data-lucide="arrow-left" class="btn__icon"></i>
                        Back to Dashboard
                    </span>
                </button>
            </div>
        </div>
        <div class="card__body">
            <p class="u-text-secondary u-mb-2">Manage system users from Keycloak with Codex-specific settings</p>
            <div class="u-flex u-flex-gap u-flex-wrap u-mb-2">
                <button class="btn btn--primary" onclick="syncAgents()">
                    <span class="btn__label">
                        <i data-lucide="refresh-cw" class="btn__icon"></i>
                        Sync from Keycloak
                    </span>
                </button>
                <button class="btn btn--primary" onclick="showCreateAgentModal()">
                    <span class="btn__label">
                        <i data-lucide="user-plus" class="btn__icon"></i>
                        Create New Agent
                    </span>
                </button>
            </div>

            <!-- Results Info -->
            <div class="results-header">
                <p class="results-header__count">
                    Total: <strong id="agent-count">Loading...</strong> agents
                </p>
            </div>

            <!-- Agents List -->
            <div id="agent-list">
                <p>Loading agents...</p>
            </div>
        </div>
    </div>

    <div id="createAgentModal" class="modal">
        <div class="modal__dialog">
            <div class="modal__header">
                <h2 class="modal__title">Create New Agent in Keycloak</h2>
                <button class="modal__close" onclick="hideCreateAgentModal()">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="modal__body">
                <form id="createAgentForm" onsubmit="event.preventDefault(); createAgent(); return false;">
                    <div class="form-group">
                        <label class="form-group__label">Username *</label>
                        <input type="text" id="username" class="form-group__input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-group__label">Email *</label>
                        <input type="email" id="email" class="form-group__input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-group__label">First Name</label>
                        <input type="text" id="firstName" class="form-group__input">
                    </div>
                    <div class="form-group">
                        <label class="form-group__label">Last Name</label>
                        <input type="text" id="lastName" class="form-group__input">
                    </div>
                    <div class="form-group">
                        <label class="form-group__label">Password *</label>
                        <input type="password" id="password" class="form-group__input" required minlength="8">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="temporary" checked>
                            Require Password Change on First Login
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="form-group__label">Theme Preference</label>
                        <select id="theme" class="form-group__input">
                            <option value="light">Light</option>
                            <option value="dark">Dark</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-group__label">Groups</label>
                        <div class="u-mt-1">
                            <div class="form-group__checkbox-wrapper">
                                <input type="checkbox" id="group-admins" class="form-group__checkbox" value="admins">
                                <label class="form-group__checkbox-label" for="group-admins">Admin</label>
                            </div>
                            <div class="form-group__checkbox-wrapper">
                                <input type="checkbox" id="group-technicians" class="form-group__checkbox" value="technicians">
                                <label class="form-group__checkbox-label" for="group-technicians">Technician</label>
                            </div>
                            <div class="form-group__checkbox-wrapper">
                                <input type="checkbox" id="group-billing" class="form-group__checkbox" value="billing">
                                <label class="form-group__checkbox-label" for="group-billing">Billing</label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal__footer">
                <button class="btn" onclick="hideCreateAgentModal()">
                    <span class="btn__label">
                        <i data-lucide="x" class="btn__icon"></i>
                        Cancel
                    </span>
                </button>
                <button class="btn btn--primary" onclick="createAgent()">
                    <span class="btn__label">
                        <i data-lucide="user-plus" class="btn__icon"></i>
                        Create Agent
                    </span>
                </button>
            </div>
        </div>
    </div>

    <div id="editAgentModal" class="modal">
        <div class="modal__dialog">
            <div class="modal__header">
                <h2 class="modal__title">Edit Agent</h2>
                <button class="modal__close" onclick="hideEditAgentModal()">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="modal__body">
                <form id="editAgentForm">
                    <input type="hidden" id="edit-keycloak-id">
                    <div class="form-group">
                        <label class="form-group__label">Username</label>
                        <input type="text" id="edit-username" class="form-group__input" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-group__label">Email</label>
                        <input type="email" id="edit-email" class="form-group__input" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-group__label">First Name</label>
                        <input type="text" id="edit-firstName" class="form-group__input">
                    </div>
                    <div class="form-group">
                        <label class="form-group__label">Last Name</label>
                        <input type="text" id="edit-lastName" class="form-group__input">
                    </div>
                    <div class="form-group">
                        <label class="form-group__label">Theme Preference</label>
                        <select id="edit-theme" class="form-group__input">
                            <option value="light">Light</option>
                            <option value="dark">Dark</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="edit-enabled">
                            Account Enabled
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="form-group__label">Groups</label>
                        <div class="u-mt-1">
                            <div class="form-group__checkbox-wrapper">
                                <input type="checkbox" id="edit-group-admins" class="form-group__checkbox" value="admins">
                                <label class="form-group__checkbox-label" for="edit-group-admins">Admin</label>
                            </div>
                            <div class="form-group__checkbox-wrapper">
                                <input type="checkbox" id="edit-group-technicians" class="form-group__checkbox" value="technicians">
                                <label class="form-group__checkbox-label" for="edit-group-technicians">Technician</label>
                            </div>
                            <div class="form-group__checkbox-wrapper">
                                <input type="checkbox" id="edit-group-billing" class="form-group__checkbox" value="billing">
                                <label class="form-group__checkbox-label" for="edit-group-billing">Billing</label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal__footer">
                <button id="deleteAgentBtn" class="btn btn--danger" onclick="deleteAgent()">
                    <span class="btn__label">
                        <i data-lucide="trash-2" class="btn__icon"></i>
                        Delete Agent
                    </span>
                </button>
                <button class="btn" onclick="showResetPasswordModal()">
                    <span class="btn__label">
                        <i data-lucide="key" class="btn__icon"></i>
                        Reset Password
                    </span>
                </button>
                <button class="btn" onclick="hideEditAgentModal()">
                    <span class="btn__label">
                        <i data-lucide="x" class="btn__icon"></i>
                        Cancel
                    </span>
                </button>
                <button class="btn btn--primary" onclick="updateAgent()">
                    <span class="btn__label">
                        <i data-lucide="save" class="btn__icon"></i>
                        Save Changes
                    </span>
                </button>
            </div>
        </div>
    </div>

    <div id="resetPasswordModal" class="modal">
        <div class="modal__dialog">
            <div class="modal__header">
                <h2 class="modal__title">Reset Password</h2>
                <button class="modal__close" onclick="hideResetPasswordModal()">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="modal__body">
                <p>Resetting password for: <strong id="reset-username"></strong></p>
                <form onsubmit="event.preventDefault(); resetPassword(); return false;">
                    <div class="form-group">
                        <label class="form-group__label" for="new-password">New Password</label>
                        <input type="password" id="new-password" class="form-group__input" required minlength="8">
                    </div>
                    <div class="form-group">
                        <label class="form-group__label" for="confirm-password">Confirm Password</label>
                        <input type="password" id="confirm-password" class="form-group__input" required minlength="8">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="temporary-password" checked>
                            Temporary (user must change on next login)
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal__footer">
                <button class="btn" onclick="hideResetPasswordModal()">
                    <span class="btn__label">
                        <i data-lucide="x" class="btn__icon"></i>
                        Cancel
                    </span>
                </button>
                <button class="btn btn--primary" onclick="resetPassword()">
                    <span class="btn__label">
                        <i data-lucide="key" class="btn__icon"></i>
                        Reset Password
                    </span>
                </button>
            </div>
        </div>
    </div>

    <script>
        let allGroups = [];
        let currentKeycloakId = null;

        function getBasePath() {
            const path = window.location.pathname;
            if (path.startsWith('/codex/')) {
                return '/codex';
            }
            return '';
        }

        async function loadAgents() {
            try {
                const basePath = getBasePath();
                const response = await fetch(`${basePath}/api/agents`, {
                    credentials: 'same-origin'
                });
                const data = await response.json();

                if (data.agents) {
                    displayAgents(data.agents);
                    document.getElementById('agent-count').textContent = data.total;
                } else {
                    document.getElementById('agent-list').innerHTML = '<p class="empty-state">No agents found</p>';
                    document.getElementById('agent-count').textContent = '0';
                }
            } catch (error) {
                document.getElementById('agent-list').innerHTML = `<p class="alert alert--error">Error loading agents: ${error.message}</p>`;
            }
        }

        function displayAgents(agents) {
            const container = document.getElementById('agent-list');
            container.innerHTML = '';

            if (agents.length === 0) {
                container.innerHTML = '<p class="empty-state">No agents found. Click "Sync from Keycloak" to import users.</p>';
                return;
            }

            agents.forEach(agent => {
                const card = document.createElement('div');
                card.className = 'agent-card';
                card.onclick = () => editAgent(agent.keycloak_id);

                const themeIcon = agent.theme_preference === 'dark'
                    ? '<i data-lucide="moon"></i>'
                    : '<i data-lucide="sun"></i>';
                const statusBadge = agent.enabled
                    ? '<span class="status-text status-text--success">Enabled</span>'
                    : '<span class="status-text status-text--danger">Disabled</span>';

                card.innerHTML = `
                    <div class="agent-card__header">
                        <h3 class="agent-card__name">${agent.username}</h3>
                        ${statusBadge}
                    </div>
                    <div class="agent-card__info">
                        <div class="agent-card__info-item">
                            <strong>Email:</strong> ${agent.email || 'N/A'}
                        </div>
                        <div class="agent-card__info-item">
                            <strong>Name:</strong> ${agent.first_name || ''} ${agent.last_name || ''}
                        </div>
                        <div class="agent-card__info-item">
                            <strong>Theme:</strong> ${themeIcon} ${agent.theme_preference}
                        </div>
                        <div class="agent-card__info-item">
                            <strong>Last Synced:</strong> ${agent.last_synced_at ? new Date(agent.last_synced_at).toLocaleDateString() : 'Never'}
                        </div>
                    </div>
                `;

                container.appendChild(card);
            });

            // Re-initialize Lucide icons after creating cards
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        async function syncAgents() {
            if (!confirm('Sync all users from Keycloak? This will update existing agents and create new ones.')) {
                return;
            }

            try {
                const basePath = getBasePath();
                document.getElementById('agent-list').innerHTML = '<p>Syncing agents from Keycloak...</p>';

                const response = await fetch(`${basePath}/api/agents/sync`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'same-origin'
                });

                const result = await response.json();

                if (result.success) {
                    alert(`Sync complete!\n\nSynced: ${result.synced}\nCreated: ${result.created}\nUpdated: ${result.updated}`);
                    loadAgents();
                } else {
                    alert('Sync failed: ' + (result.error || 'Unknown error'));
                    loadAgents();
                }
            } catch (error) {
                alert('Error: ' + error.message);
                loadAgents();
            }
        }

        function showCreateAgentModal() {
            document.getElementById('createAgentModal').classList.add('active');
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        function hideCreateAgentModal() {
            document.getElementById('createAgentModal').classList.remove('active');
            document.getElementById('createAgentForm').reset();
        }

        async function createAgent() {
            const userData = {
                username: document.getElementById('username').value,
                email: document.getElementById('email').value,
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                enabled: true
            };

            const password = document.getElementById('password').value;
            const temporary = document.getElementById('temporary').checked;
            const theme = document.getElementById('theme').value;

            // Get selected groups
            const selectedGroups = [];
            ['admins', 'technicians', 'billing'].forEach(groupName => {
                if (document.getElementById(`group-${groupName}`).checked) {
                    selectedGroups.push(groupName);
                }
            });

            try {
                const basePath = getBasePath();

                // Create user in Keycloak via Helm API
                const helmUrl = '/helm'; // Assuming Helm is accessible via Nexus
                const createResponse = await fetch(`${helmUrl}/api/keycloak/users`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(userData),
                    credentials: 'same-origin'
                });

                if (!createResponse.ok) {
                    const error = await createResponse.json();
                    alert('Error creating agent in Keycloak: ' + (error.error || 'Unknown error'));
                    return;
                }

                // Re-sync to pull the new user into Codex
                await fetch(`${basePath}/api/agents/sync`, {
                    method: 'POST',
                    credentials: 'same-origin'
                });

                // Find the newly created agent and set theme
                const agentsResponse = await fetch(`${basePath}/api/agents`, {
                    credentials: 'same-origin'
                });
                const agentsData = await agentsResponse.json();
                const newAgent = agentsData.agents.find(a => a.email === userData.email);

                if (newAgent && theme !== 'light') {
                    // Update theme if not default
                    await fetch(`${basePath}/api/agents/${newAgent.keycloak_id}/settings`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ theme_preference: theme }),
                        credentials: 'same-origin'
                    });
                }

                alert('Agent created successfully!');
                hideCreateAgentModal();
                loadAgents();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function editAgent(keycloakId) {
            currentKeycloakId = keycloakId;

            try {
                const basePath = getBasePath();

                // Get agent from Codex
                const response = await fetch(`${basePath}/api/agents/${keycloakId}`, {
                    credentials: 'same-origin'
                });
                const agent = await response.json();

                // Populate form
                document.getElementById('edit-keycloak-id').value = agent.keycloak_id;
                document.getElementById('edit-username').value = agent.username;
                document.getElementById('edit-email').value = agent.email;
                document.getElementById('edit-firstName').value = agent.first_name || '';
                document.getElementById('edit-lastName').value = agent.last_name || '';
                document.getElementById('edit-theme').value = agent.theme_preference || 'light';
                document.getElementById('edit-enabled').checked = agent.enabled;

                // Fetch and display group membership from Keycloak via Helm API
                try {
                    const helmUrl = '/helm';
                    const groupsResponse = await fetch(`${helmUrl}/api/keycloak/users/${keycloakId}/groups`, {
                        credentials: 'same-origin'
                    });

                    if (groupsResponse.ok) {
                        const groupsData = await groupsResponse.json();
                        const userGroups = groupsData.groups || [];

                        // Uncheck all groups first
                        document.getElementById('edit-group-admins').checked = false;
                        document.getElementById('edit-group-technicians').checked = false;
                        document.getElementById('edit-group-billing').checked = false;

                        // Check groups user is member of
                        userGroups.forEach(group => {
                            const groupName = group.name || group;
                            if (groupName === 'admins') {
                                document.getElementById('edit-group-admins').checked = true;
                            } else if (groupName === 'technicians') {
                                document.getElementById('edit-group-technicians').checked = true;
                            } else if (groupName === 'billing') {
                                document.getElementById('edit-group-billing').checked = true;
                            }
                        });
                    }
                } catch (groupError) {
                    console.error('Error loading groups:', groupError);
                }

                // Hide delete button if this is the admin user
                const deleteBtn = document.getElementById('deleteAgentBtn');
                if (agent.username.toLowerCase() === 'admin') {
                    deleteBtn.classList.add('u-hidden');
                } else {
                    deleteBtn.classList.remove('u-hidden');
                }

                document.getElementById('editAgentModal').classList.add('active');
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            } catch (error) {
                alert('Error loading agent: ' + error.message);
            }
        }

        function hideEditAgentModal() {
            document.getElementById('editAgentModal').classList.remove('active');
            currentKeycloakId = null;
        }

        async function updateAgent() {
            const keycloakId = document.getElementById('edit-keycloak-id').value;
            const theme = document.getElementById('edit-theme').value;

            try {
                const basePath = getBasePath();

                // Update theme in Codex
                const response = await fetch(`${basePath}/api/agents/${keycloakId}/settings`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ theme_preference: theme }),
                    credentials: 'same-origin'
                });

                if (!response.ok) {
                    const error = await response.json();
                    alert('Error updating agent theme: ' + (error.error || 'Unknown error'));
                    return;
                }

                // Update groups in Keycloak via Helm
                const selectedGroups = [];
                if (document.getElementById('edit-group-admins').checked) selectedGroups.push('admins');
                if (document.getElementById('edit-group-technicians').checked) selectedGroups.push('technicians');
                if (document.getElementById('edit-group-billing').checked) selectedGroups.push('billing');

                const helmUrl = '/helm';
                const groupsResponse = await fetch(`${helmUrl}/api/keycloak/users/${keycloakId}/groups`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ groups: selectedGroups }),
                    credentials: 'same-origin'
                });

                if (groupsResponse.ok) {
                    alert('Agent updated successfully!');
                    hideEditAgentModal();
                    loadAgents();
                } else {
                    const error = await groupsResponse.json();
                    alert('Warning: Theme saved but group update failed: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function deleteAgent() {
            const username = document.getElementById('edit-username').value;

            // Prevent deletion of admin user
            if (username.toLowerCase() === 'admin') {
                alert('Cannot delete the admin user!');
                return;
            }

            if (!confirm('Are you sure you want to delete this agent from Keycloak?')) {
                return;
            }

            const keycloakId = document.getElementById('edit-keycloak-id').value;

            try {
                const helmUrl = '/helm';
                const response = await fetch(`${helmUrl}/api/keycloak/users/${keycloakId}`, {
                    method: 'DELETE',
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    alert('Agent deleted successfully!');
                    hideEditAgentModal();

                    // Re-sync to remove from Codex
                    const basePath = getBasePath();
                    await fetch(`${basePath}/api/agents/sync`, {
                        method: 'POST',
                        credentials: 'same-origin'
                    });

                    loadAgents();
                } else {
                    const error = await response.json();
                    alert('Error deleting agent: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function showResetPasswordModal() {
            const username = document.getElementById('edit-username').value;
            document.getElementById('reset-username').textContent = username;
            document.getElementById('editAgentModal').classList.remove('active');
            document.getElementById('resetPasswordModal').classList.add('active');
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        function hideResetPasswordModal() {
            document.getElementById('resetPasswordModal').classList.remove('active');
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-password').value = '';
            document.getElementById('editAgentModal').classList.add('active');
        }

        async function resetPassword() {
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const temporary = document.getElementById('temporary-password').checked;

            if (newPassword !== confirmPassword) {
                alert('Passwords do not match!');
                return;
            }

            if (newPassword.length < 8) {
                alert('Password must be at least 8 characters long!');
                return;
            }

            const keycloakId = document.getElementById('edit-keycloak-id').value;

            try {
                const helmUrl = '/helm';
                const response = await fetch(`${helmUrl}/api/keycloak/users/${keycloakId}/reset-password`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ password: newPassword, temporary }),
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    alert('Password reset successfully!');
                    hideResetPasswordModal();
                } else {
                    const error = await response.json();
                    alert('Error resetting password: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Close modals when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                if (e.target.id === 'createAgentModal') {
                    hideCreateAgentModal();
                } else if (e.target.id === 'editAgentModal') {
                    hideEditAgentModal();
                } else if (e.target.id === 'resetPasswordModal') {
                    hideResetPasswordModal();
                }
            }
        });

        // Load agents on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadAgents();
            lucide.createIcons();
        });
    </script>
</body>
</html>
