<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Settings - Codex</title>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
    <div class="card">
        <div class="card__header">
            <h1 class="card__title">User Settings</h1>
            <p>Personalize your HiveMatrix experience</p>
        </div>
        <div class="card__body">
            <!-- User Info Section -->
            <div class="u-mb-2">
                <h2>Account Information</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-item__label">Username</span>
                        <span class="info-item__value" id="user-username">Loading...</span>
                    </div>
                    <div class="info-item">
                        <span class="info-item__label">Email</span>
                        <span class="info-item__value" id="user-email">Loading...</span>
                    </div>
                </div>
            </div>

            <div class="section-divider"></div>

            <!-- Theme Settings Section -->
            <div class="u-mb-2">
                <h2>Appearance</h2>
                <p class="u-text-secondary u-mb-1">
                    Choose your preferred color theme. Changes apply immediately across all HiveMatrix services.
                </p>

                <div class="theme-selector">
                    <div class="theme-option" id="theme-light" onclick="selectTheme('light')">
                        <div class="theme-option__preview theme-option__preview--light">
                            <div class="preview-header"></div>
                            <div class="preview-sidebar"></div>
                            <div class="preview-content"></div>
                        </div>
                        <div class="theme-option__info">
                            <h3 class="theme-option__name">‚òÄÔ∏è Light Theme</h3>
                            <p class="theme-option__desc">Clean and bright interface</p>
                        </div>
                        <div class="theme-option__indicator"></div>
                    </div>

                    <div class="theme-option" id="theme-dark" onclick="selectTheme('dark')">
                        <div class="theme-option__preview theme-option__preview--dark">
                            <div class="preview-header"></div>
                            <div class="preview-sidebar"></div>
                            <div class="preview-content"></div>
                        </div>
                        <div class="theme-option__info">
                            <h3 class="theme-option__name">üåô Dark Theme</h3>
                            <p class="theme-option__desc">Easy on the eyes for long sessions</p>
                        </div>
                        <div class="theme-option__indicator"></div>
                    </div>
                </div>
            </div>

            <div class="section-divider"></div>

            <!-- Save Button -->
            <div class="action-footer">
                <button class="btn btn--primary" onclick="saveSettings()" id="save-btn">
                    <span class="btn__label">
                        <i data-lucide="save" class="btn__icon"></i>
                        Save Settings
                    </span>
                </button>
                <span id="save-status" class="u-ml-1 u-text-success"></span>
            </div>
        </div>
    </div>

    <script>
        let currentTheme = 'light';
        let savedTheme = 'light';

        function getBasePath() {
            const path = window.location.pathname;
            if (path.startsWith('/codex/')) {
                return '/codex';
            }
            return '';
        }

        async function loadSettings() {
            try {
                const basePath = getBasePath();
                const response = await fetch(`${basePath}/api/my/settings`, {
                    credentials: 'same-origin'
                });
                const data = await response.json();

                if (data.synced) {
                    document.getElementById('user-username').textContent = data.username || 'N/A';
                    document.getElementById('user-email').textContent = data.email || 'N/A';
                    currentTheme = data.theme_preference || 'light';
                    savedTheme = currentTheme;
                    selectTheme(currentTheme, false);
                } else {
                    // User not synced yet
                    document.getElementById('user-username').textContent = 'Not synced';
                    document.getElementById('user-email').textContent = 'Not synced';
                    document.getElementById('save-status').innerHTML = '<span class="alert alert--warning">Your account hasn\'t been synced from Keycloak yet. Ask an admin to sync agents.</span>';
                }
            } catch (error) {
                console.error('Error loading settings:', error);
                document.getElementById('save-status').innerHTML = '<span class="alert alert--error">Error loading settings</span>';
            }
        }

        function selectTheme(theme, markUnsaved = true) {
            currentTheme = theme;

            // Update UI
            document.getElementById('theme-light').classList.toggle('selected', theme === 'light');
            document.getElementById('theme-dark').classList.toggle('selected', theme === 'dark');

            // Apply theme immediately for preview
            document.documentElement.setAttribute('data-theme', theme);

            if (markUnsaved && theme !== savedTheme) {
                document.getElementById('save-status').innerHTML = '<span style="color: var(--color-warning);">Unsaved changes</span>';
            }
        }

        async function saveSettings() {
            const saveBtn = document.getElementById('save-btn');
            const saveStatus = document.getElementById('save-status');

            saveBtn.disabled = true;
            saveBtn.innerHTML = '<span class="btn__label"><i data-lucide="loader" class="btn__icon"></i>Saving...</span>';
            saveStatus.textContent = '';
            lucide.createIcons();

            try {
                const basePath = getBasePath();
                const response = await fetch(`${basePath}/api/my/settings`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        theme_preference: currentTheme
                    }),
                    credentials: 'same-origin'
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    savedTheme = currentTheme;
                    saveStatus.innerHTML = '<span style="color: var(--color-success);">‚úì Settings saved! Theme will apply across all HiveMatrix services.</span>';

                    // Reload page after 1 second to apply theme globally
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    saveStatus.innerHTML = `<span class="alert alert--error">Error: ${result.error || 'Failed to save settings'}</span>`;
                }
            } catch (error) {
                saveStatus.innerHTML = `<span class="alert alert--error">Error: ${error.message}</span>`;
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<span class="btn__label"><i data-lucide="save" class="btn__icon"></i>Save Settings</span>';
                lucide.createIcons();
            }
        }

        // Load settings on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            lucide.createIcons();
        });
    </script>
</body>
</html>
