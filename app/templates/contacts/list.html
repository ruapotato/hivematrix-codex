<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contacts - Codex</title>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
    <div class="card">
        <div class="card__header">
            <h1 class="card__title">Contacts</h1>
            <div class="card__header-actions">
                <button class="btn" onclick="window.location.href='{{ url_for('index') }}'">
                    <span class="btn__label">
                        <i data-lucide="arrow-left" class="btn__icon"></i>
                        Back to Dashboard
                    </span>
                </button>
            </div>
        </div>
        <div class="card__body">
            <!-- Search Box -->
            <form method="GET" action="{{ url_for('contacts.list_contacts') }}" class="search-form">
                <div class="search-form__controls">
                    <input
                        type="text"
                        name="search"
                        placeholder="Search by name, email, or phone..."
                        value="{{ search_query or '' }}"
                        class="search-form__input"
                    >
                    <button type="submit" class="btn btn--primary">
                        <span class="btn__label">
                            <i data-lucide="search" class="btn__icon"></i>
                            Search
                        </span>
                    </button>
                    {% if search_query %}
                    <a href="{{ url_for('contacts.list_contacts') }}">
                        <button type="button" class="btn">
                            <span class="btn__label">
                                <i data-lucide="x" class="btn__icon"></i>
                                Clear
                            </span>
                        </button>
                    </a>
                    {% endif %}
                </div>
            </form>

            <!-- Results Info -->
            <div class="results-header">
                <p class="results-header__count">
                    {% if search_query %}
                        Showing <strong>{{ pagination.total }}</strong> results for "{{ search_query }}"
                    {% else %}
                        Total: <strong>{{ pagination.total }}</strong> contacts
                    {% endif %}
                </p>
                <div class="results-header__controls">
                    <label>
                        <input type="checkbox" id="show_inactive" onchange="toggleInactive(this.checked)" {{ 'checked' if show_inactive else '' }}>
                        Show Inactive
                    </label>
                    <label for="per_page">Per page:</label>
                    <select id="per_page" onchange="changePerPage(this.value)">
                        <option value="25" {{ 'selected' if per_page == 25 else '' }}>25</option>
                        <option value="50" {{ 'selected' if per_page == 50 else '' }}>50</option>
                        <option value="100" {{ 'selected' if per_page == 100 else '' }}>100</option>
                    </select>
                </div>
            </div>

            <!-- Contacts Table -->
            <div class="table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th class="sortable-header">
                                <a href="{{ url_for('contacts.list_contacts', sort_by='name', order='desc' if sort_by == 'name' and order == 'asc' else 'asc', per_page=per_page, search=search_query, show_inactive='1' if show_inactive else '0') }}">
                                    Name {{ '↓' if sort_by == 'name' and order == 'desc' else '↑' if sort_by == 'name' else '' }}
                                </a>
                            </th>
                            <th class="sortable-header">
                                <a href="{{ url_for('contacts.list_contacts', sort_by='email', order='desc' if sort_by == 'email' and order == 'asc' else 'asc', per_page=per_page, search=search_query, show_inactive='1' if show_inactive else '0') }}">
                                    Email {{ '↓' if sort_by == 'email' and order == 'desc' else '↑' if sort_by == 'email' else '' }}
                                </a>
                            </th>
                            <th>Phone</th>
                            <th>Company</th>
                            {% if show_inactive %}
                            <th class="sortable-header text-center">
                                <a href="{{ url_for('contacts.list_contacts', sort_by='active', order='desc' if sort_by == 'active' and order == 'asc' else 'asc', per_page=per_page, search=search_query, show_inactive='1' if show_inactive else '0') }}">
                                    Active {{ '↓' if sort_by == 'active' and order == 'desc' else '↑' if sort_by == 'active' else '' }}
                                </a>
                            </th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for contact in contacts %}
                        <tr>
                            <td>
                                <a href="{{ url_for('contacts.contact_details', contact_id=contact.id) }}">
                                    <strong>{{ contact.name }}</strong>
                                </a>
                            </td>
                            <td>
                                <a href="mailto:{{ contact.email }}">
                                    {{ contact.email }}
                                </a>
                            </td>
                            <td>{{ contact.mobile_phone_number or contact.work_phone_number or '-' }}</td>
                            <td>
                                {% if contact.companies %}
                                    {% for company in contact.companies %}
                                        <a href="{{ url_for('companies.company_details', account_number=company.account_number) }}">
                                            {{ company.name }}
                                        </a>{% if not loop.last %}, {% endif %}
                                    {% endfor %}
                                {% else %}
                                    <span>No company</span>
                                {% endif %}
                            </td>
                            {% if show_inactive %}
                            <td class="text-center">
                                {% if contact.active %}
                                    <span class="badge badge--success" style="color: var(--color-success);">
                                        <i data-lucide="check" style="width: 14px; height: 14px; vertical-align: middle;"></i>
                                        Active
                                    </span>
                                {% else %}
                                    <span class="badge badge--danger" style="color: var(--color-danger);">
                                        <i data-lucide="x" style="width: 14px; height: 14px; vertical-align: middle;"></i>
                                        Inactive
                                    </span>
                                {% endif %}
                            </td>
                            {% endif %}
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="{{ '5' if show_inactive else '4' }}" class="empty-state">
                                {% if search_query %}
                                    No contacts found matching "{{ search_query }}". Try a different search term.
                                {% else %}
                                    No contacts found. Run Freshservice sync to import data.
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Pagination Controls -->
            {% if pagination.pages > 1 %}
            <div class="pagination">
                {% if pagination.has_prev %}
                    <a href="{{ url_for('contacts.list_contacts', page=1, per_page=per_page, sort_by=sort_by, order=order, search=search_query, show_inactive='1' if show_inactive else '0') }}">
                        <button class="btn">
                            <span class="btn__label">
                                <i data-lucide="chevrons-left" class="btn__icon"></i>
                                First
                            </span>
                        </button>
                    </a>
                    <a href="{{ url_for('contacts.list_contacts', page=pagination.prev_num, per_page=per_page, sort_by=sort_by, order=order, search=search_query, show_inactive='1' if show_inactive else '0') }}">
                        <button class="btn">
                            <span class="btn__label">
                                <i data-lucide="chevron-left" class="btn__icon"></i>
                                Previous
                            </span>
                        </button>
                    </a>
                {% endif %}

                <span class="pagination__info">
                    Page {{ pagination.page }} of {{ pagination.pages }}
                </span>

                {% if pagination.has_next %}
                    <a href="{{ url_for('contacts.list_contacts', page=pagination.next_num, per_page=per_page, sort_by=sort_by, order=order, search=search_query, show_inactive='1' if show_inactive else '0') }}">
                        <button class="btn">
                            <span class="btn__label">
                                Next
                                <i data-lucide="chevron-right" class="btn__icon"></i>
                            </span>
                        </button>
                    </a>
                    <a href="{{ url_for('contacts.list_contacts', page=pagination.pages, per_page=per_page, sort_by=sort_by, order=order, search=search_query, show_inactive='1' if show_inactive else '0') }}">
                        <button class="btn">
                            <span class="btn__label">
                                Last
                                <i data-lucide="chevrons-right" class="btn__icon"></i>
                            </span>
                        </button>
                    </a>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

    <script>
        function changePerPage(value) {
            const url = new URL(window.location.href);
            url.searchParams.set('per_page', value);
            url.searchParams.set('page', '1'); // Reset to first page
            window.location.href = url.toString();
        }

        function toggleInactive(checked) {
            const url = new URL(window.location.href);
            url.searchParams.set('show_inactive', checked ? '1' : '0');
            url.searchParams.set('page', '1'); // Reset to first page
            window.location.href = url.toString();
        }

        // Initialize Lucide icons
        window.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
        });
    </script>
</body>
</html>
