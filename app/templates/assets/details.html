<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ asset.hostname }} - Codex</title>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
    <div class="card">
        <div class="card__header">
            <h1 class="card__title">{{ asset.hostname }}</h1>
            <div class="card__header-actions">
                <button class="btn" onclick="window.location.href='{{ url_for('assets.list_assets') }}'">
                    <span class="btn__label">
                        <i data-lucide="arrow-left" class="btn__icon"></i>
                        Back to Assets
                    </span>
                </button>
            </div>
        </div>
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            <div class="card__body">
                {% for category, message in messages %}
                    <div class="alert alert--{{ 'success' if category == 'success' else 'error' }}">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
            {% endif %}
        {% endwith %}
    </div>

    <div class="card">
        <div class="card__header">
            <h2 class="card__title">Device Information</h2>
            {% if asset.web_remote_url %}
            <div class="card__header-actions">
                <a href="{{ asset.web_remote_url }}" target="_blank">
                    <button class="btn btn--primary btn--small">
                        <span class="btn__label">
                            <i data-lucide="monitor" class="btn__icon"></i>
                            Remote Access
                        </span>
                    </button>
                </a>
            </div>
            {% endif %}
        </div>
        <div class="card__body">
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-item__label">Company:</span>
                    <span class="info-item__value">
                        {% if asset.company %}
                            <a href="{{ url_for('companies.company_details', account_number=asset.company.account_number) }}">
                                {{ asset.company.name }}
                            </a>
                        {% else %}
                            N/A
                        {% endif %}
                    </span>
                </div>
                <div class="info-item">
                    <span class="info-item__label">Hardware Type:</span>
                    <span class="info-item__value">{{ asset.hardware_type or 'N/A' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-item__label">Operating System:</span>
                    <span class="info-item__value">{{ asset.operating_system or 'N/A' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-item__label">Status:</span>
                    <span class="info-item__value">
                        {% if asset.online %}
                            <span class="status-text status-text--success">Online</span>
                        {% else %}
                            <span class="status-text status-text--danger">Offline</span>
                        {% endif %}
                    </span>
                </div>
                <div class="info-item">
                    <span class="info-item__label">Internal IP:</span>
                    <span class="info-item__value">{{ asset.int_ip_address or 'N/A' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-item__label">External IP:</span>
                    <span class="info-item__value">{{ asset.ext_ip_address or 'N/A' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-item__label">Domain:</span>
                    <span class="info-item__value">{{ asset.domain or 'N/A' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-item__label">Last Seen:</span>
                    <span class="info-item__value">{{ asset.last_seen or 'N/A' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-item__label">Last Logged In User:</span>
                    <span class="info-item__value">{{ asset.last_logged_in_user or 'N/A' }}</span>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card__header">
            <h2 class="card__title">Assigned Users ({{ asset.contacts|length }})</h2>
        </div>
        <div class="card__body">
            {% if asset.contacts %}
            <div class="user-list">
                {% for contact in asset.contacts %}
                <div class="user-item">
                    <div class="user-item__info">
                        <a href="{{ url_for('contacts.contact_details', contact_id=contact.id) }}" class="user-item__name">
                            {{ contact.name }}
                        </a>
                        <span class="user-item__email">{{ contact.email }}</span>
                    </div>
                    <form method="POST" action="{{ url_for('assets.unassign_user', asset_id=asset.id, contact_id=contact.id) }}" class="user-item__action">
                        <button type="submit" class="btn btn--danger btn--small" onclick="return confirm('Remove {{ contact.name }} from this device?')">
                            <span class="btn__label">
                                <i data-lucide="user-minus" class="btn__icon"></i>
                                Remove
                            </span>
                        </button>
                    </form>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="empty-state">No users assigned to this device.</p>
            {% endif %}

            {% if available_contacts %}
            <div class="section-divider"></div>
            <h3 class="u-mt-2 u-mb-1">Assign New User</h3>
            <form method="POST" action="{{ url_for('assets.assign_user', asset_id=asset.id) }}" class="form-inline">
                <div class="form-inline__controls">
                    <select name="contact_id" class="form-inline__select" required>
                        <option value="">Select a user...</option>
                        {% for contact in available_contacts %}
                            {% if contact not in asset.contacts %}
                            <option value="{{ contact.id }}">{{ contact.name }} ({{ contact.email }})</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                    <button type="submit" class="btn btn--primary">
                        <span class="btn__label">
                            <i data-lucide="user-plus" class="btn__icon"></i>
                            Assign User
                        </span>
                    </button>
                </div>
            </form>
            {% else %}
            <div class="section-divider"></div>
            <p class="u-text-secondary u-mt-2">No additional users available from {{ asset.company.name if asset.company else 'this company' }}.</p>
            {% endif %}
        </div>
    </div>

    <script>
        window.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
        });
    </script>
</body>
</html>
