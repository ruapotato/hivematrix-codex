<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assets - Codex</title>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
    <div class="card">
        <div class="card__header">
            <h1 class="card__title">Assets</h1>
            <div class="card__header-actions">
                <button class="btn" onclick="window.location.href='{{ url_for('index') }}'">
                    <span class="btn__label">
                        <i data-lucide="arrow-left" class="btn__icon"></i>
                        Back to Dashboard
                    </span>
                </button>
            </div>
        </div>
        <div class="card__body">
            <!-- Search Box -->
            <form id="searchForm" class="search-form" onsubmit="return false;">
                <div class="search-form__controls">
                    <input
                        type="text"
                        id="searchInput"
                        name="search"
                        placeholder="Search by hostname, description, or company..."
                        value="{{ search_query or '' }}"
                        class="search-form__input"
                    >
                    <button type="button" class="btn" id="clearBtn" onclick="clearSearch()" style="display: {{ 'inline-block' if search_query else 'none' }};">
                        <span class="btn__label">
                            <i data-lucide="x" class="btn__icon"></i>
                            Clear
                        </span>
                    </button>
                </div>
            </form>

            <!-- Results Info -->
            <div class="results-header">
                <p class="results-header__count" id="resultsCount">
                    {% if search_query %}
                        Showing <strong>{{ pagination.total }}</strong> results for "{{ search_query }}"
                    {% else %}
                        Total: <strong>{{ pagination.total }}</strong> assets
                    {% endif %}
                </p>
                <div class="results-header__controls">
                    <button class="btn btn--small" onclick="toggleColumnChooser()">
                        <span class="btn__label">
                            <i data-lucide="columns" class="btn__icon"></i>
                            Columns
                        </span>
                    </button>
                    <label for="per_page">Per page:</label>
                    <select id="per_page" onchange="changePerPage(this.value)">
                        <option value="25" {{ 'selected' if per_page == 25 else '' }}>25</option>
                        <option value="50" {{ 'selected' if per_page == 50 else '' }}>50</option>
                        <option value="100" {{ 'selected' if per_page == 100 else '' }}>100</option>
                    </select>
                </div>
            </div>

            <!-- Column Chooser -->
            <div id="columnChooser" class="card u-mb-2" style="display: none;">
                <div class="card__body">
                    <h3 class="u-mb-1">Show/Hide Columns</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.5rem;">
                        <label>
                            <input type="checkbox" checked disabled> Hostname
                        </label>
                        <label>
                            <input type="checkbox" id="col-company" checked onchange="toggleColumn('company')"> Company
                        </label>
                        <label>
                            <input type="checkbox" id="col-type" checked onchange="toggleColumn('type')"> Type
                        </label>
                        <label>
                            <input type="checkbox" id="col-os" checked onchange="toggleColumn('os')"> OS
                        </label>
                        <label>
                            <input type="checkbox" id="col-antivirus" onchange="toggleColumn('antivirus')"> Antivirus
                        </label>
                        <label>
                            <input type="checkbox" id="col-int_ip" onchange="toggleColumn('int_ip')"> Internal IP
                        </label>
                        <label>
                            <input type="checkbox" id="col-ext_ip" onchange="toggleColumn('ext_ip')"> External IP
                        </label>
                        <label>
                            <input type="checkbox" id="col-domain" onchange="toggleColumn('domain')"> Domain
                        </label>
                        <label>
                            <input type="checkbox" id="col-last_user" checked onchange="toggleColumn('last_user')"> Last User
                        </label>
                        <label>
                            <input type="checkbox" id="col-last_seen" onchange="toggleColumn('last_seen')"> Last Seen
                        </label>
                        <label>
                            <input type="checkbox" id="col-patch_status" onchange="toggleColumn('patch_status')"> Patch Status
                        </label>
                        <label>
                            <input type="checkbox" id="col-status" checked onchange="toggleColumn('status')"> Status
                        </label>
                        <label>
                            <input type="checkbox" id="col-remote" checked onchange="toggleColumn('remote')"> Remote Access
                        </label>
                    </div>
                </div>
            </div>

            <!-- Assets Table -->
            <div class="table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th data-column="hostname" class="sortable-header">Hostname</th>
                            <th data-column="company">Company</th>
                            <th data-column="type" class="sortable-header">Type</th>
                            <th data-column="os" class="sortable-header">OS</th>
                            <th data-column="antivirus">Antivirus</th>
                            <th data-column="int_ip">Internal IP</th>
                            <th data-column="ext_ip">External IP</th>
                            <th data-column="domain">Domain</th>
                            <th data-column="last_user">Last User</th>
                            <th data-column="last_seen">Last Seen</th>
                            <th data-column="patch_status">Patch Status</th>
                            <th data-column="status" class="sortable-header u-text-center">Status</th>
                            <th data-column="remote" class="u-text-center">Remote Access</th>
                        </tr>
                    </thead>
                    <tbody id="assetsTableBody">
                        {% for asset in assets %}
                        <tr>
                            <td data-column="hostname">
                                <a href="{{ url_for('assets.asset_details', asset_id=asset.id) }}">
                                    <strong>{{ asset.hostname }}</strong>
                                </a>
                            </td>
                            <td data-column="company">
                                {% if asset.company %}
                                    <a href="{{ url_for('companies.company_details', account_number=asset.company.account_number) }}">
                                        {{ asset.company.name }}
                                    </a>
                                {% else %}
                                    <span>Unassigned</span>
                                {% endif %}
                            </td>
                            <td data-column="type">{{ asset.hardware_type or 'N/A' }}</td>
                            <td data-column="os">{{ asset.operating_system or 'N/A' }}</td>
                            <td data-column="antivirus">{{ asset.antivirus_product or '-' }}</td>
                            <td data-column="int_ip">{{ asset.int_ip_address or '-' }}</td>
                            <td data-column="ext_ip">{{ asset.ext_ip_address or '-' }}</td>
                            <td data-column="domain">{{ asset.domain or '-' }}</td>
                            <td data-column="last_user">{{ asset.last_logged_in_user or '-' }}</td>
                            <td data-column="last_seen">{{ asset.last_seen or '-' }}</td>
                            <td data-column="patch_status">{{ asset.patch_status or '-' }}</td>
                            <td data-column="status" class="u-text-center">
                                {% if asset.online %}
                                    <span class="badge badge--success">Online</span>
                                {% else %}
                                    <span class="badge badge--danger">Offline</span>
                                {% endif %}
                            </td>
                            <td data-column="remote" class="u-text-center">
                                {% if asset.web_remote_url %}
                                    <a href="{{ asset.web_remote_url }}" target="_blank">
                                        <button class="btn btn--primary btn--small">
                                            <span class="btn__label">
                                                <i data-lucide="monitor" class="btn__icon"></i>
                                                Remote Access
                                            </span>
                                        </button>
                                    </a>
                                {% else %}
                                    <span class="u-text-secondary">-</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="13" class="empty-state">
                                {% if search_query %}
                                    No assets found matching "{{ search_query }}". Try a different search term.
                                {% else %}
                                    No assets found. Run Datto RMM sync to import data.
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Pagination Controls -->
            <div class="pagination" id="paginationControls" style="display: {{ 'flex' if pagination.pages > 1 else 'none' }};">
                <!-- Pagination will be dynamically updated -->
            </div>
        </div>
    </div>

    <script>
        let currentPage = {{ pagination.page }};
        let currentPerPage = {{ per_page }};
        let currentSortBy = '{{ sort_by }}';
        let currentOrder = '{{ order }}';
        let currentSearch = '{{ search_query or '' }}';
        let searchTimeout = null;

        function getBasePath() {
            const path = window.location.pathname;
            if (path.startsWith('/codex/')) {
                return '/codex';
            }
            return '';
        }

        // Real-time search with debouncing
        document.getElementById('searchInput').addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                currentSearch = e.target.value.trim();
                currentPage = 1;
                loadAssets();
                document.getElementById('clearBtn').style.display = currentSearch ? 'inline-block' : 'none';
            }, 300);
        });

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            currentSearch = '';
            currentPage = 1;
            document.getElementById('clearBtn').style.display = 'none';
            loadAssets();
        }

        function changePerPage(value) {
            currentPerPage = parseInt(value);
            currentPage = 1;
            loadAssets();
        }

        function changePage(page) {
            currentPage = page;
            loadAssets();
        }

        async function loadAssets() {
            const basePath = getBasePath();
            const params = new URLSearchParams({
                page: currentPage,
                per_page: currentPerPage,
                sort_by: currentSortBy,
                order: currentOrder,
                search: currentSearch
            });

            try {
                const response = await fetch(`${basePath}/assets/api/search?${params}`, {
                    credentials: 'same-origin'
                });

                if (!response.ok) throw new Error('Failed to fetch assets');

                const data = await response.json();
                updateTable(data.assets);
                updatePagination(data.pagination);
                updateResultsCount(data.pagination.total);
                lucide.createIcons();
            } catch (error) {
                console.error('Error loading assets:', error);
                alert('Error loading assets. Please try again.');
            }
        }

        function updateTable(assets) {
            const tbody = document.getElementById('assetsTableBody');
            const basePath = getBasePath();

            if (assets.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="13" class="empty-state">
                            ${currentSearch ?
                                `No assets found matching "${currentSearch}". Try a different search term.` :
                                'No assets found. Run Datto RMM sync to import data.'}
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = assets.map(asset => {
                const companyCell = asset.company_name ?
                    `<a href="${basePath}/companies/${asset.company_account_number}">${asset.company_name}</a>` :
                    '<span>Unassigned</span>';

                const statusCell = asset.online ?
                    '<span class="badge badge--success">Online</span>' :
                    '<span class="badge badge--danger">Offline</span>';

                const remoteAccessCell = asset.web_remote_url ?
                    `<a href="${asset.web_remote_url}" target="_blank">
                        <button class="btn btn--primary btn--small">
                            <span class="btn__label">
                                <i data-lucide="monitor" class="btn__icon"></i>
                                Remote Access
                            </span>
                        </button>
                    </a>` :
                    '<span class="u-text-secondary">-</span>';

                return `
                    <tr>
                        <td data-column="hostname">
                            <a href="${basePath}/assets/${asset.id}">
                                <strong>${asset.hostname}</strong>
                            </a>
                        </td>
                        <td data-column="company">${companyCell}</td>
                        <td data-column="type">${asset.hardware_type || 'N/A'}</td>
                        <td data-column="os">${asset.operating_system || 'N/A'}</td>
                        <td data-column="antivirus">${asset.antivirus_product || '-'}</td>
                        <td data-column="int_ip">${asset.int_ip_address || '-'}</td>
                        <td data-column="ext_ip">${asset.ext_ip_address || '-'}</td>
                        <td data-column="domain">${asset.domain || '-'}</td>
                        <td data-column="last_user">${asset.last_logged_in_user || '-'}</td>
                        <td data-column="last_seen">${asset.last_seen || '-'}</td>
                        <td data-column="patch_status">${asset.patch_status || '-'}</td>
                        <td data-column="status" class="u-text-center">${statusCell}</td>
                        <td data-column="remote" class="u-text-center">${remoteAccessCell}</td>
                    </tr>
                `;
            }).join('');

            // Re-apply column visibility preferences
            loadColumnPreferences();
        }

        function updatePagination(pagination) {
            const container = document.getElementById('paginationControls');

            if (pagination.pages <= 1) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'flex';
            let html = '';

            if (pagination.has_prev) {
                html += `
                    <button class="btn" onclick="changePage(1)">
                        <span class="btn__label">
                            <i data-lucide="chevrons-left" class="btn__icon"></i>
                            First
                        </span>
                    </button>
                    <button class="btn" onclick="changePage(${pagination.prev_num})">
                        <span class="btn__label">
                            <i data-lucide="chevron-left" class="btn__icon"></i>
                            Previous
                        </span>
                    </button>
                `;
            }

            html += `<span class="pagination__info">Page ${pagination.page} of ${pagination.pages}</span>`;

            if (pagination.has_next) {
                html += `
                    <button class="btn" onclick="changePage(${pagination.next_num})">
                        <span class="btn__label">
                            Next
                            <i data-lucide="chevron-right" class="btn__icon"></i>
                        </span>
                    </button>
                    <button class="btn" onclick="changePage(${pagination.pages})">
                        <span class="btn__label">
                            Last
                            <i data-lucide="chevrons-right" class="btn__icon"></i>
                        </span>
                    </button>
                `;
            }

            container.innerHTML = html;

            // Re-initialize lucide icons for pagination buttons
            lucide.createIcons();
        }

        function updateResultsCount(total) {
            const countElement = document.getElementById('resultsCount');
            if (currentSearch) {
                countElement.innerHTML = `Showing <strong>${total}</strong> results for "${currentSearch}"`;
            } else {
                countElement.innerHTML = `Total: <strong>${total}</strong> assets`;
            }
        }

        function toggleColumnChooser() {
            const chooser = document.getElementById('columnChooser');
            chooser.style.display = chooser.style.display === 'none' ? 'block' : 'none';
        }

        function toggleColumn(columnName) {
            const isChecked = document.getElementById(`col-${columnName}`).checked;
            const headers = document.querySelectorAll(`th[data-column="${columnName}"]`);
            const cells = document.querySelectorAll(`td[data-column="${columnName}"]`);

            headers.forEach(th => {
                th.style.display = isChecked ? '' : 'none';
            });

            cells.forEach(td => {
                td.style.display = isChecked ? '' : 'none';
            });

            // Save preference to localStorage
            localStorage.setItem(`assets_column_${columnName}`, isChecked);
        }

        function loadColumnPreferences() {
            const columns = ['company', 'type', 'os', 'antivirus', 'int_ip', 'ext_ip', 'domain', 'last_user', 'last_seen', 'patch_status', 'status', 'remote'];
            const defaultHidden = ['antivirus', 'int_ip', 'ext_ip', 'domain', 'last_seen', 'patch_status'];

            columns.forEach(column => {
                const saved = localStorage.getItem(`assets_column_${column}`);
                const checkbox = document.getElementById(`col-${column}`);

                if (!checkbox) return;

                if (saved !== null) {
                    // Use saved preference
                    const isVisible = saved === 'true';
                    checkbox.checked = isVisible;
                } else {
                    // Use default visibility
                    const isVisible = !defaultHidden.includes(column);
                    checkbox.checked = isVisible;
                }

                toggleColumn(column);
            });
        }

        window.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            loadColumnPreferences();

            // Initialize pagination on page load
            const initialPagination = {
                page: {{ pagination.page }},
                pages: {{ pagination.pages }},
                total: {{ pagination.total }},
                has_prev: {{ 'true' if pagination.has_prev else 'false' }},
                has_next: {{ 'true' if pagination.has_next else 'false' }},
                prev_num: {{ pagination.prev_num if pagination.has_prev else 1 }},
                next_num: {{ pagination.next_num if pagination.has_next else 1 }}
            };
            updatePagination(initialPagination);

            // Re-render icons after pagination is created
            setTimeout(() => lucide.createIcons(), 100);
        });
    </script>
</body>
</html>
