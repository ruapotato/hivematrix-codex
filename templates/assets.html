{% extends 'base.html' %}

{% block title %}Assets - Nexus{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold">Assets</h1>
    <div class="flex items-center space-x-4">
        <div class="flex items-center space-x-2">
            <span class="text-sm text-gray-700">Show</span>
            <select id="per_page_selector" class="form-select text-sm rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
                <option value="200" {% if per_page == 200 %}selected{% endif %}>200</option>
                <option value="500" {% if per_page == 500 %}selected{% endif %}>500</option>
            </select>
            <span class="text-sm text-gray-700">entries</span>
        </div>
        <div class="relative" x-data="{ open: false }">
            <button @click="open = !open" class="p-2 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                <svg class="h-6 w-6 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V7a2 2 0 012-2h10a2 2 0 012 2v8a2 2 0 01-2 2z" />
                </svg>
            </button>
            <div x-show="open" @click.away="open = false" class="absolute right-0 mt-2 w-56 bg-white rounded-md shadow-lg z-10" style="display: none;">
                <div class="p-4">
                    <h4 class="text-sm font-semibold text-gray-700 mb-2">Visible Columns</h4>
                    <div id="column-toggles" class="space-y-2">
                        </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="bg-white p-6 rounded-lg shadow-md">
    <div class="overflow-x-auto">
        <table id="assets-table" class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th data-column="hostname" scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                        <a href="{{ url_for('assets.list_assets', sort_by='hostname', order='desc' if sort_by == 'hostname' and order == 'asc' else 'asc', per_page=per_page) }}">Hostname {% if sort_by == 'hostname' %}{{ '▲' if order == 'asc' else '▼' }}{% endif %}</a>
                    </th>
                    <th data-column="company" scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                        <a href="{{ url_for('assets.list_assets', sort_by='company', order='desc' if sort_by == 'company' and order == 'asc' else 'asc', per_page=per_page) }}">Company {% if sort_by == 'company' %}{{ '▲' if order == 'asc' else '▼' }}{% endif %}</a>
                    </th>
                    <th data-column="description" scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                        <a href="{{ url_for('assets.list_assets', sort_by='description', order='desc' if sort_by == 'description' and order == 'asc' else 'asc', per_page=per_page) }}">Description {% if sort_by == 'description' %}{{ '▲' if order == 'asc' else '▼' }}{% endif %}</a>
                    </th>
                    <th data-column="domain" scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                        <a href="{{ url_for('assets.list_assets', sort_by='domain', order='desc' if sort_by == 'domain' and order == 'asc' else 'asc', per_page=per_page) }}">Domain {% if sort_by == 'domain' %}{{ '▲' if order == 'asc' else '▼' }}{% endif %}</a>
                    </th>
                    <th data-column="hardware_type" scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                        <a href="{{ url_for('assets.list_assets', sort_by='hardware_type', order='desc' if sort_by == 'hardware_type' and order == 'asc' else 'asc', per_page=per_page) }}">Hardware Type {% if sort_by == 'hardware_type' %}{{ '▲' if order == 'asc' else '▼' }}{% endif %}</a>
                    </th>
                    <th data-column="device_type" scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                        <a href="{{ url_for('assets.list_assets', sort_by='device_type', order='desc' if sort_by == 'device_type' and order == 'asc' else 'asc', per_page=per_page) }}">Device Type {% if sort_by == 'device_type' %}{{ '▲' if order == 'asc' else '▼' }}{% endif %}</a>
                    </th>
                    <th data-column="operating_system" scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                        <a href="{{ url_for('assets.list_assets', sort_by='operating_system', order='desc' if sort_by == 'operating_system' and order == 'asc' else 'asc', per_page=per_page) }}">Operating System {% if sort_by == 'operating_system' %}{{ '▲' if order == 'asc' else '▼' }}{% endif %}</a>
                    </th>
                    <th data-column="int_ip_address" scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                        <a href="{{ url_for('assets.list_assets', sort_by='int_ip_address', order='desc' if sort_by == 'int_ip_address' and order == 'asc' else 'asc', per_page=per_page) }}">Internal IP {% if sort_by == 'int_ip_address' %}{{ '▲' if order == 'asc' else '▼' }}{% endif %}</a>
                    </th>
                    <th data-column="ext_ip_address" scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                        <a href="{{ url_for('assets.list_assets', sort_by='ext_ip_address', order='desc' if sort_by == 'ext_ip_address' and order == 'asc' else 'asc', per_page=per_page) }}">External IP {% if sort_by == 'ext_ip_address' %}{{ '▲' if order == 'asc' else '▼' }}{% endif %}</a>
                    </th>
                    <th data-column="last_logged_in_user" scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                        <a href="{{ url_for('assets.list_assets', sort_by='last_logged_in_user', order='desc' if sort_by == 'last_logged_in_user' and order == 'asc' else 'asc', per_page=per_page) }}">Last User {% if sort_by == 'last_logged_in_user' %}{{ '▲' if order == 'asc' else '▼' }}{% endif %}</a>
                    </th>
                    <th data-column="antivirus_product" scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                         <a href="{{ url_for('assets.list_assets', sort_by='antivirus_product', order='desc' if sort_by == 'antivirus_product' and order == 'asc' else 'asc', per_page=per_page) }}">Antivirus {% if sort_by == 'antivirus_product' %}{{ '▲' if order == 'asc' else '▼' }}{% endif %}</a>
                    </th>
                    <th data-column="patch_status" scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                        <a href="{{ url_for('assets.list_assets', sort_by='patch_status', order='desc' if sort_by == 'patch_status' and order == 'asc' else 'asc', per_page=per_page) }}">Patch Status {% if sort_by == 'patch_status' %}{{ '▲' if order == 'asc' else '▼' }}{% endif %}</a>
                    </th>
                    <th data-column="online" scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                        <a href="{{ url_for('assets.list_assets', sort_by='online', order='desc' if sort_by == 'online' and order == 'asc' else 'asc', per_page=per_page) }}">Online {% if sort_by == 'online' %}{{ '▲' if order == 'asc' else '▼' }}{% endif %}</a>
                    </th>
                    <th data-column="backup_usage_tb" scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                        <a href="{{ url_for('assets.list_assets', sort_by='backup_usage_tb', order='desc' if sort_by == 'backup_usage_tb' and order == 'asc' else 'asc', per_page=per_page) }}">Backup (TB) {% if sort_by == 'backup_usage_tb' %}{{ '▲' if order == 'asc' else '▼' }}{% endif %}</a>
                    </th>
                    <th data-column="last_seen" scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                         <a href="{{ url_for('assets.list_assets', sort_by='last_seen', order='desc' if sort_by == 'last_seen' and order == 'asc' else 'asc', per_page=per_page) }}">Last Seen {% if sort_by == 'last_seen' %}{{ '▲' if order == 'asc' else '▼' }}{% endif %}</a>
                    </th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for asset in assets %}
                <tr>
                    <td data-column="hostname" class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        <a href="{{ url_for('assets.asset_details', asset_id=asset.id) }}" class="text-indigo-600 hover:text-indigo-900">{{ asset.hostname }}</a>
                    </td>
                    <td data-column="company" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ asset.company.name if asset.company else 'N/A' }}</td>
                    <td data-column="description" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ asset.description or 'N/A' }}</td>
                    <td data-column="domain" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ asset.domain or 'N/A' }}</td>
                    <td data-column="hardware_type" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ asset.hardware_type or 'N/A' }}</td>
                    <td data-column="device_type" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ asset.device_type or 'N/A' }}</td>
                    <td data-column="operating_system" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ asset.operating_system }}</td>
                    <td data-column="int_ip_address" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ asset.int_ip_address or 'N/A' }}</td>
                    <td data-column="ext_ip_address" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ asset.ext_ip_address or 'N/A' }}</td>
                    <td data-column="last_logged_in_user" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ asset.last_logged_in_user or 'N/A' }}</td>
                    <td data-column="antivirus_product" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ asset.antivirus_product or 'N/A' }}</td>
                    <td data-column="patch_status" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ asset.patch_status or 'N/A' }}</td>
                    <td data-column="online" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full {{ 'bg-green-100 text-green-800' if asset.online else 'bg-red-100 text-red-800' }}">
                            {{ 'Online' if asset.online else 'Offline' }}
                        </span>
                    </td>
                    <td data-column="backup_usage_tb" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ asset.backup_usage_tb or 'N/A' }}</td>
                    <td data-column="last_seen" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ asset.last_seen or 'N/A' }}</td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="15" class="px-6 py-4 text-center text-gray-500">No assets found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="mt-4 flex justify-between items-center">
        <div>
            <p class="text-sm text-gray-700">
                Showing
                <span class="font-medium">{{ pagination.first }}</span>
                to
                <span class="font-medium">{{ pagination.last }}</span>
                of
                <span class="font-medium">{{ pagination.total }}</span>
                results
            </p>
        </div>
        {% if pagination.pages > 1 %}
        <div class="flex-1 flex justify-end">
            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                <a href="{{ url_for('assets.list_assets', page=pagination.prev_num, per_page=per_page, sort_by=sort_by, order=order) if pagination.has_prev else '#' }}"
                   class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 {% if not pagination.has_prev %}cursor-not-allowed opacity-50{% endif %}">
                    <span>Previous</span>
                </a>
                {% for p in pagination.iter_pages(left_edge=2, right_edge=2, left_current=2, right_current=2) %}
                    {% if p %}
                        <a href="{{ url_for('assets.list_assets', page=p, per_page=per_page, sort_by=sort_by, order=order) }}"
                           class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium {% if p == pagination.page %}bg-indigo-50 border-indigo-500 text-indigo-600{% else %}text-gray-700 hover:bg-gray-50{% endif %}">
                            {{ p }}
                        </a>
                    {% else %}
                        <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">...</span>
                    {% endif %}
                {% endfor %}
                <a href="{{ url_for('assets.list_assets', page=pagination.next_num, per_page=per_page, sort_by=sort_by, order=order) if pagination.has_next else '#' }}"
                   class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 {% if not pagination.has_next %}cursor-not-allowed opacity-50{% endif %}">
                    <span>Next</span>
                </a>
            </nav>
        </div>
        {% endif %}
    </div>
</div>

<script src="//unpkg.com/alpinejs" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Per Page Selector Logic
    document.getElementById('per_page_selector').addEventListener('change', function() {
        const perPage = this.value;
        const currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set('per_page', perPage);
        currentUrl.searchParams.set('page', 1);
        window.location.href = currentUrl.toString();
    });

    // Column Chooser Logic
    const tableId = 'assets-table';
    const storageKey = 'assetColumnVisibility';
    const columns = {
        'hostname': 'Hostname',
        'company': 'Company',
        'description': 'Description',
        'domain': 'Domain',
        'hardware_type': 'Hardware Type',
        'device_type': 'Device Type',
        'operating_system': 'Operating System',
        'int_ip_address': 'Internal IP',
        'ext_ip_address': 'External IP',
        'last_logged_in_user': 'Last User',
        'antivirus_product': 'Antivirus',
        'patch_status': 'Patch Status',
        'online': 'Online',
        'backup_usage_tb': 'Backup (TB)',
        'last_seen': 'Last Seen',
    };

    const togglesContainer = document.getElementById('column-toggles');
    const table = document.getElementById(tableId);

    let savedVisibility = JSON.parse(localStorage.getItem(storageKey));
    if (!savedVisibility) {
        savedVisibility = {
            'hostname': true, 'company': true, 'description': false, 'domain': false,
            'hardware_type': true, 'device_type': true, 'operating_system': true,
            'int_ip_address': false, 'ext_ip_address': false, 'last_logged_in_user': false,
            'antivirus_product': true, 'patch_status': true, 'online': true,
            'backup_usage_tb': false, 'last_seen': false
        };
    }

    const updateTableVisibility = () => {
        const headers = table.querySelectorAll('th');
        const rows = table.querySelectorAll('tbody tr');

        headers.forEach(header => {
            const columnKey = header.getAttribute('data-column');
            if (columnKey) {
                header.style.display = savedVisibility[columnKey] ? '' : 'none';
            }
        });

        rows.forEach(row => {
            if (row.querySelector('td').getAttribute('colspan')) return;
            const cells = row.querySelectorAll('td');
            cells.forEach(cell => {
                const columnKey = cell.getAttribute('data-column');
                if (columnKey) {
                    cell.style.display = savedVisibility[columnKey] ? '' : 'none';
                }
            });
        });
    };

    Object.keys(columns).forEach(key => {
        const label = document.createElement('label');
        label.className = 'flex items-center space-x-2 text-sm text-gray-600';
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'form-checkbox h-4 w-4 text-indigo-600 rounded';
        checkbox.dataset.column = key;
        checkbox.checked = savedVisibility[key] !== false;
        checkbox.addEventListener('change', (e) => {
            const columnKey = e.target.dataset.column;
            savedVisibility[columnKey] = e.target.checked;
            localStorage.setItem(storageKey, JSON.stringify(savedVisibility));
            updateTableVisibility();
        });
        const span = document.createElement('span');
        span.textContent = columns[key];
        label.appendChild(checkbox);
        label.appendChild(span);
        togglesContainer.appendChild(label);
    });

    updateTableVisibility();
});
</script>
{% endblock %}
