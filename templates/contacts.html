{% extends 'base.html' %}

{% block title %}Contacts - Nexus{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold">Contacts</h1>
    <div class="flex items-center space-x-4">
        <div class="flex items-center space-x-2">
            <span class="text-sm text-gray-700">Show</span>
            <select id="per_page_selector" class="form-select text-sm rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
                <option value="200" {% if per_page == 200 %}selected{% endif %}>200</option>
                <option value="500" {% if per_page == 500 %}selected{% endif %}>500</option>
            </select>
            <span class="text-sm text-gray-700">entries</span>
        </div>
        <div class="relative" x-data="{ open: false }">
            <button @click="open = !open" class="p-2 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                <svg class="h-6 w-6 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V7a2 2 0 012-2h10a2 2 0 012 2v8a2 2 0 01-2 2z" />
                </svg>
            </button>
            <div x-show="open" @click.away="open = false" class="absolute right-0 mt-2 w-56 bg-white rounded-md shadow-lg z-10" style="display: none;">
                <div class="p-4">
                    <h4 class="text-sm font-semibold text-gray-700 mb-2">Visible Columns</h4>
                    <div id="column-toggles" class="space-y-2">
                        </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="bg-white p-6 rounded-lg shadow-md">
    <div class="overflow-x-auto">
        <table id="contacts-table" class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th data-column="name" scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        <a href="{{ url_for('contacts.list_contacts', sort_by='name', order='desc' if sort_by == 'name' and order == 'asc' else 'asc', per_page=per_page) }}" class="hover:text-gray-900">
                            Name {% if sort_by == 'name' %}{{ '▲' if order == 'asc' else '▼' }}{% endif %}
                        </a>
                    </th>
                    <th data-column="email" scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        <a href="{{ url_for('contacts.list_contacts', sort_by='email', order='desc' if sort_by == 'email' and order == 'asc' else 'asc', per_page=per_page) }}" class="hover:text-gray-900">
                            Email {% if sort_by == 'email' %}{{ '▲' if order == 'asc' else '▼' }}{% endif %}
                        </a>
                    </th>
                    <th data-column="company" scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        <a href="{{ url_for('contacts.list_contacts', sort_by='company', order='desc' if sort_by == 'company' and order == 'asc' else 'asc', per_page=per_page) }}" class="hover:text-gray-900">
                            Company {% if sort_by == 'company' %}{{ '▲' if order == 'asc' else '▼' }}{% endif %}
                        </a>
                    </th>
                    <th data-column="active" scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        <a href="{{ url_for('contacts.list_contacts', sort_by='active', order='desc' if sort_by == 'active' and order == 'asc' else 'asc', per_page=per_page) }}" class="hover:text-gray-900">
                            Active {% if sort_by == 'active' %}{{ '▲' if order == 'asc' else '▼' }}{% endif %}
                        </a>
                    </th>
                    <th data-column="mobile_phone_number" scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        <a href="{{ url_for('contacts.list_contacts', sort_by='mobile_phone_number', order='desc' if sort_by == 'mobile_phone_number' and order == 'asc' else 'asc', per_page=per_page) }}" class="hover:text-gray-900">
                            Mobile Phone {% if sort_by == 'mobile_phone_number' %}{{ '▲' if order == 'asc' else '▼' }}{% endif %}
                        </a>
                    </th>
                    <th data-column="work_phone_number" scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        <a href="{{ url_for('contacts.list_contacts', sort_by='work_phone_number', order='desc' if sort_by == 'work_phone_number' and order == 'asc' else 'asc', per_page=per_page) }}" class="hover:text-gray-900">
                            Work Phone {% if sort_by == 'work_phone_number' %}{{ '▲' if order == 'asc' else '▼' }}{% endif %}
                        </a>
                    </th>
                    <th data-column="associated_assets" scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        <a href="{{ url_for('contacts.list_contacts', sort_by='associated_assets', order='desc' if sort_by == 'associated_assets' and order == 'asc' else 'asc', per_page=per_page) }}" class="hover:text-gray-900">
                            Associated Assets {% if sort_by == 'associated_assets' %}{{ '▲' if order == 'asc' else '▼' }}{% endif %}
                        </a>
                    </th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for contact in contacts %}
                <tr>
                    <td data-column="name" class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        <a href="{{ url_for('contacts.contact_details', contact_id=contact.id) }}" class="text-indigo-600 hover:text-indigo-900">{{ contact.name }}</a>
                    </td>
                    <td data-column="email" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ contact.email }}</td>
                    <td data-column="company" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ contact.company.name if contact.company else 'N/A' }}</td>
                    <td data-column="active" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ 'Yes' if contact.active else 'No' }}</td>
                    <td data-column="mobile_phone_number" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ contact.mobile_phone_number or 'N/A' }}</td>
                    <td data-column="work_phone_number" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ contact.work_phone_number or 'N/A' }}</td>
                    <td data-column="associated_assets" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ contact.assets|map(attribute='hostname')|join(', ') if contact.assets else 'N/A' }}</td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="7" class="px-6 py-4 text-center text-gray-500">No contacts found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="mt-4 flex justify-between items-center">
        <div>
            <p class="text-sm text-gray-700">
                Showing
                <span class="font-medium">{{ pagination.first }}</span>
                to
                <span class="font-medium">{{ pagination.last }}</span>
                of
                <span class="font-medium">{{ pagination.total }}</span>
                results
            </p>
        </div>
        {% if pagination.pages > 1 %}
        <div class="flex-1 flex justify-end">
            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                <a href="{{ url_for('contacts.list_contacts', page=pagination.prev_num, per_page=per_page, sort_by=sort_by, order=order) if pagination.has_prev else '#' }}"
                   class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 {% if not pagination.has_prev %}cursor-not-allowed opacity-50{% endif %}">
                    <span>Previous</span>
                </a>
                {% for p in pagination.iter_pages(left_edge=2, right_edge=2, left_current=2, right_current=2) %}
                    {% if p %}
                        <a href="{{ url_for('contacts.list_contacts', page=p, per_page=per_page, sort_by=sort_by, order=order) }}"
                           class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium {% if p == pagination.page %}bg-indigo-50 border-indigo-500 text-indigo-600{% else %}text-gray-700 hover:bg-gray-50{% endif %}">
                            {{ p }}
                        </a>
                    {% else %}
                        <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">...</span>
                    {% endif %}
                {% endfor %}
                <a href="{{ url_for('contacts.list_contacts', page=pagination.next_num, per_page=per_page, sort_by=sort_by, order=order) if pagination.has_next else '#' }}"
                   class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 {% if not pagination.has_next %}cursor-not-allowed opacity-50{% endif %}">
                    <span>Next</span>
                </a>
            </nav>
        </div>
        {% endif %}
    </div>
</div>

<script src="//unpkg.com/alpinejs" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Per Page Selector Logic
    document.getElementById('per_page_selector').addEventListener('change', function() {
        const perPage = this.value;
        const currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set('per_page', perPage);
        currentUrl.searchParams.set('page', 1); // Reset to first page when changing items per page
        window.location.href = currentUrl.toString();
    });

    // Column Chooser Logic
    const tableId = 'contacts-table';
    const storageKey = 'contactColumnVisibility';
    const columns = {
        'name': 'Name',
        'email': 'Email',
        'company': 'Company',
        'active': 'Active',
        'mobile_phone_number': 'Mobile Phone',
        'work_phone_number': 'Work Phone',
        'associated_assets': 'Associated Assets',
    };

    const togglesContainer = document.getElementById('column-toggles');
    const table = document.getElementById(tableId);

    let savedVisibility = JSON.parse(localStorage.getItem(storageKey));
    if (!savedVisibility) {
        savedVisibility = { 'name': true, 'email': true, 'company': true, 'active': false, 'mobile_phone_number': false, 'work_phone_number': false, 'associated_assets': false };
    }

    const updateTableVisibility = () => {
        const headers = table.querySelectorAll('th');
        const rows = table.querySelectorAll('tbody tr');

        headers.forEach(header => {
            const columnKey = header.getAttribute('data-column');
            if (columnKey) {
                header.style.display = savedVisibility[columnKey] ? '' : 'none';
            }
        });

        rows.forEach(row => {
            if (row.querySelector('td').getAttribute('colspan')) return; // Skip 'no results' row
            const cells = row.querySelectorAll('td');
            cells.forEach(cell => {
                const columnKey = cell.getAttribute('data-column');
                if (columnKey) {
                    cell.style.display = savedVisibility[columnKey] ? '' : 'none';
                }
            });
        });
    };

    Object.keys(columns).forEach(key => {
        const label = document.createElement('label');
        label.className = 'flex items-center space-x-2 text-sm text-gray-600';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'form-checkbox h-4 w-4 text-indigo-600 rounded';
        checkbox.dataset.column = key;
        checkbox.checked = savedVisibility[key] !== false;

        checkbox.addEventListener('change', (e) => {
            const columnKey = e.target.dataset.column;
            savedVisibility[columnKey] = e.target.checked;
            localStorage.setItem(storageKey, JSON.stringify(savedVisibility));
            updateTableVisibility();
        });

        const span = document.createElement('span');
        span.textContent = columns[key];

        label.appendChild(checkbox);
        label.appendChild(span);
        togglesContainer.appendChild(label);
    });

    updateTableVisibility();
});
</script>
{% endblock %}
