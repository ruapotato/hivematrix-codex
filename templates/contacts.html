{% extends 'base.html' %}

{% block title %}Contacts - Nexus{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold">Contacts</h1>
    <div class="flex items-center space-x-4">
        <form id="filter-form" method="GET" action="{{ url_for('contacts.list_contacts') }}" class="flex items-center">
            <input type="text" name="search" placeholder="Search..." value="{{ search_query or '' }}" class="form-input rounded-l-md border-gray-300">
            <input type="hidden" name="show_inactive" value="{{ 'true' if show_inactive else 'false' }}">
            <button type="submit" class="py-2 px-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-r-md">Search</button>
        </form>
        <div class="flex items-center">
            <input type="checkbox" id="show_inactive_checkbox" {% if show_inactive %}checked{% endif %} class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
            <label for="show_inactive_checkbox" class="ml-2 text-sm text-gray-700">Show Inactive</label>
        </div>
        <button class="py-2 px-4 bg-green-500 hover:bg-green-600 text-white font-semibold rounded-md shadow-md" onclick="openAddContactModal()">New Contact</button>
        <div class="flex items-center space-x-2">
            <span class="text-sm text-gray-700">Show</span>
            <select id="per_page_selector" class="form-select text-sm rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
                <option value="200" {% if per_page == 200 %}selected{% endif %}>200</option>
                <option value="500" {% if per_page == 500 %}selected{% endif %}>500</option>
            </select>
            <span class="text-sm text-gray-700">entries</span>
        </div>
        <div class="relative" x-data="{ open: false }">
            <button @click="open = !open" class="p-2 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                <svg class="h-6 w-6 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V7a2 2 0 012-2h10a2 2 0 012 2v8a2 2 0 01-2 2z" />
                </svg>
            </button>
            <div x-show="open" @click.away="open = false" class="absolute right-0 mt-2 w-56 bg-white rounded-md shadow-lg z-10" style="display: none;">
                <div class="p-4">
                    <h4 class="text-sm font-semibold text-gray-700 mb-2">Visible Columns</h4>
                    <div id="column-toggles" class="space-y-2">
                        </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="bg-white p-6 rounded-lg shadow-md">
    <div class="overflow-x-auto">
        <table id="contacts-table" class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th data-column="name" scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        <a href="{{ url_for('contacts.list_contacts', sort_by='name', order='desc' if sort_by == 'name' and order == 'asc' else 'asc', per_page=per_page) }}" class="hover:text-gray-900">
                            Name {% if sort_by == 'name' %}{{ '▲' if order == 'asc' else '▼' }}{% endif %}
                        </a>
                    </th>
                    <th data-column="email" scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        <a href="{{ url_for('contacts.list_contacts', sort_by='email', order='desc' if sort_by == 'email' and order == 'asc' else 'asc', per_page=per_page) }}" class="hover:text-gray-900">
                            Email {% if sort_by == 'email' %}{{ '▲' if order == 'asc' else '▼' }}{% endif %}
                        </a>
                    </th>
                    <th data-column="company" scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        <a href="{{ url_for('contacts.list_contacts', sort_by='company', order='desc' if sort_by == 'company' and order == 'asc' else 'asc', per_page=per_page) }}" class="hover:text-gray-900">
                            Company {% if sort_by == 'company' %}{{ '▲' if order == 'asc' else '▼' }}{% endif %}
                        </a>
                    </th>
                    <th data-column="active" scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        <a href="{{ url_for('contacts.list_contacts', sort_by='active', order='desc' if sort_by == 'active' and order == 'asc' else 'asc', per_page=per_page) }}" class="hover:text-gray-900">
                            Active {% if sort_by == 'active' %}{{ '▲' if order == 'asc' else '▼' }}{% endif %}
                        </a>
                    </th>
                    <th data-column="mobile_phone_number" scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        <a href="{{ url_for('contacts.list_contacts', sort_by='mobile_phone_number', order='desc' if sort_by == 'mobile_phone_number' and order == 'asc' else 'asc', per_page=per_page) }}" class="hover:text-gray-900">
                            Mobile Phone {% if sort_by == 'mobile_phone_number' %}{{ '▲' if order == 'asc' else '▼' }}{% endif %}
                        </a>
                    </th>
                    <th data-column="work_phone_number" scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        <a href="{{ url_for('contacts.list_contacts', sort_by='work_phone_number', order='desc' if sort_by == 'work_phone_number' and order == 'asc' else 'asc', per_page=per_page) }}" class="hover:text-gray-900">
                            Work Phone {% if sort_by == 'work_phone_number' %}{{ '▲' if order == 'asc' else '▼' }}{% endif %}
                        </a>
                    </th>
                    <th data-column="associated_assets" scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        <a href="{{ url_for('contacts.list_contacts', sort_by='associated_assets', order='desc' if sort_by == 'associated_assets' and order == 'asc' else 'asc', per_page=per_page) }}" class="hover:text-gray-900">
                            Associated Assets {% if sort_by == 'associated_assets' %}{{ '▲' if order == 'asc' else '▼' }}{% endif %}
                        </a>
                    </th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for contact in contacts %}
                <tr>
                    <td data-column="name" class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        <a href="{{ url_for('contacts.contact_details', contact_id=contact.id) }}" class="text-indigo-600 hover:text-indigo-900">{{ contact.name }}</a>
                    </td>
                    <td data-column="email" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ contact.email }}</td>
                    <td data-column="company" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ contact.companies|map(attribute='name')|join(', ') if contact.companies else 'N/A' }}</td>
                    <td data-column="active" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ 'Yes' if contact.active else 'No' }}</td>
                    <td data-column="mobile_phone_number" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ contact.mobile_phone_number or 'N/A' }}</td>
                    <td data-column="work_phone_number" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ contact.work_phone_number or 'N/A' }}</td>
                    <td data-column="associated_assets" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ contact.assets|map(attribute='hostname')|join(', ') if contact.assets else 'N/A' }}</td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="7" class="px-6 py-4 text-center text-gray-500">No contacts found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="mt-4 flex justify-between items-center">
        <div>
            <p class="text-sm text-gray-700">
                Showing
                <span class="font-medium">{{ pagination.first }}</span>
                to
                <span class="font-medium">{{ pagination.last }}</span>
                of
                <span class="font-medium">{{ pagination.total }}</span>
                results
            </p>
        </div>
        {% if pagination.pages > 1 %}
        <div class="flex-1 flex justify-end">
            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                <a href="{{ url_for('contacts.list_contacts', page=pagination.prev_num, per_page=per_page, sort_by=sort_by, order=order) if pagination.has_prev else '#' }}"
                   class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 {% if not pagination.has_prev %}cursor-not-allowed opacity-50{% endif %}">
                    <span>Previous</span>
                </a>
                {% for p in pagination.iter_pages(left_edge=2, right_edge=2, left_current=2, right_current=2) %}
                    {% if p %}
                        <a href="{{ url_for('contacts.list_contacts', page=p, per_page=per_page, sort_by=sort_by, order=order) }}"
                           class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium {% if p == pagination.page %}bg-indigo-50 border-indigo-500 text-indigo-600{% else %}text-gray-700 hover:bg-gray-50{% endif %}">
                            {{ p }}
                        </a>
                    {% else %}
                        <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">...</span>
                    {% endif %}
                {% endfor %}
                <a href="{{ url_for('contacts.list_contacts', page=pagination.next_num, per_page=per_page, sort_by=sort_by, order=order) if pagination.has_next else '#' }}"
                   class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 {% if not pagination.has_next %}cursor-not-allowed opacity-50{% endif %}">
                    <span>Next</span>
                </a>
            </nav>
        </div>
        {% endif %}
    </div>
</div>

<div id="addContactModal" class="fixed z-10 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
  <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
        <form method="POST" action="{{ url_for('contacts.add_contact') }}">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Add New Contact</h3>
                <div class="mt-4 space-y-4">
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700">Full Name</label>
                        <input type="text" name="name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700">Email Address</label>
                        <input type="email" name="email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="company_account_numbers" class="block text-sm font-medium text-gray-700">Company</label>
                        <select name="company_account_numbers" multiple required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                            {% for company in companies %}
                                <option value="{{ company.account_number }}">{{ company.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label for="title" class="block text-sm font-medium text-gray-700">Title</label>
                        <input type="text" name="title" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                     <div>
                        <label for="work_phone_number" class="block text-sm font-medium text-gray-700">Work Phone</label>
                        <input type="text" name="work_phone_number" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                     <div>
                        <label for="mobile_phone_number" class="block text-sm font-medium text-gray-700">Mobile Phone</label>
                        <input type="text" name="mobile_phone_number" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700 sm:ml-3 sm:w-auto sm:text-sm">
                    Create Contact
                </button>
                <button type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm" onclick="closeAddContactModal()">
                    Cancel
                </button>
            </div>
        </form>
    </div>
  </div>
</div>

<script src="//unpkg.com/alpinejs" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Per Page Selector Logic
    document.getElementById('per_page_selector').addEventListener('change', function() {
        const perPage = this.value;
        const currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set('per_page', perPage);
        currentUrl.searchParams.set('page', 1); // Reset to first page when changing items per page
        window.location.href = currentUrl.toString();
    });

    // Show Inactive Checkbox Logic
    document.getElementById('show_inactive_checkbox').addEventListener('change', function() {
        const form = document.getElementById('filter-form');
        const showInactiveInput = form.querySelector('input[name="show_inactive"]');
        showInactiveInput.value = this.checked ? 'true' : 'false';
        form.submit();
    });

    // Column Chooser Logic
    const tableId = 'contacts-table';
    const storageKey = 'contactColumnVisibility';
    const columns = {
        'name': 'Name',
        'email': 'Email',
        'company': 'Company',
        'active': 'Active',
        'mobile_phone_number': 'Mobile Phone',
        'work_phone_number': 'Work Phone',
        'associated_assets': 'Associated Assets',
    };

    const togglesContainer = document.getElementById('column-toggles');
    const table = document.getElementById(tableId);

    let savedVisibility = JSON.parse(localStorage.getItem(storageKey));
    if (!savedVisibility) {
        savedVisibility = { 'name': true, 'email': true, 'company': true, 'active': false, 'mobile_phone_number': false, 'work_phone_number': false, 'associated_assets': false };
    }

    const updateTableVisibility = () => {
        const headers = table.querySelectorAll('th');
        const rows = table.querySelectorAll('tbody tr');

        headers.forEach(header => {
            const columnKey = header.getAttribute('data-column');
            if (columnKey) {
                header.style.display = savedVisibility[columnKey] ? '' : 'none';
            }
        });

        rows.forEach(row => {
            if (row.querySelector('td').getAttribute('colspan')) return; // Skip 'no results' row
            const cells = row.querySelectorAll('td');
            cells.forEach(cell => {
                const columnKey = cell.getAttribute('data-column');
                if (columnKey) {
                    cell.style.display = savedVisibility[columnKey] ? '' : 'none';
                }
            });
        });
    };

    Object.keys(columns).forEach(key => {
        const label = document.createElement('label');
        label.className = 'flex items-center space-x-2 text-sm text-gray-600';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'form-checkbox h-4 w-4 text-indigo-600 rounded';
        checkbox.dataset.column = key;
        checkbox.checked = savedVisibility[key] !== false;

        checkbox.addEventListener('change', (e) => {
            const columnKey = e.target.dataset.column;
            savedVisibility[columnKey] = e.target.checked;
            localStorage.setItem(storageKey, JSON.stringify(savedVisibility));
            updateTableVisibility();
        });

        const span = document.createElement('span');
        span.textContent = columns[key];

        label.appendChild(checkbox);
        label.appendChild(span);
        togglesContainer.appendChild(label);
    });

    updateTableVisibility();
});

function openAddContactModal() {
    document.getElementById('addContactModal').classList.remove('hidden');
}

function closeAddContactModal() {
    document.getElementById('addContactModal').classList.add('hidden');
}
</script>
{% endblock %}
