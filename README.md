
# **Nexus - Client Database Service**

Nexus is the central service for managing companies, contacts, assets, and users within the HiveMatrix PSA ecosystem. It provides a web interface for data entry, a scheduler for automated data synchronization, and a set of REST APIs for other microservices to consume.

## **Project Structure**

```
.
├── main.py                     # Main Flask application file
├── init_db.py                  # Database initialization script
├── scheduler.py                # Scheduler script for running background jobs
├── gen_certs.py                # Script to generate self-signed SSL certs for HTTPS
├── decorators.py               # Custom decorators for authentication and authorization
├── extensions.py               # Flask extension initializations
├── models.py                   # SQLAlchemy database models
├── pull_datto.py               # Script to pull data from Datto RMM
├── pull_freshservice.py        # Script to pull data from Freshservice
├── requirements.txt            # Python dependencies
├── certs/
│   ├── cert.pem                # SSL Certificate (generated by gen_certs.py)
│   └── key.pem                 # SSL Private Key (generated by gen_certs.py)
├── instance/
│   └── nexus.conf              # Configuration file (created on first run)
│   └── nexus_brainhair.db      # SQLite database file (created on first run)
├── routes/
│   ├── assets.py
│   ├── companies.py
│   ├── contacts.py
│   ├── settings.py
│   └── users.py
└── templates/
    ├── base.html
    ├── login.html
    ├── dashboard.html
    # ... and other HTML templates

```

## **Setup and Installation**

Follow these steps to get the Nexus service running locally.

### **1. Create a Virtual Environment**

It's recommended to use a virtual environment to manage project dependencies.

```
# For Linux/macOS
python3 -m venv venv
source venv/bin/activate

# For Windows
python -m venv venv
.\venv\Scripts\activate

```

### **2. Install Dependencies**

Install the required Python packages using pip.

```
pip install -r requirements.txt

```

### **3. Initialize the Database**

The first time you run the application, you need to create the database tables, the default admin user, and the configuration file. If you are updating the application after a database model change, you may need to delete the old `nexus_brainhair.db` file before running this command.

```
python init_db.py

```

This command will:

1.  Create the `instance` folder if it doesn't exist.
    
2.  Create the `nexus_brainhair.db` SQLite file.
    
3.  Create the necessary database tables based on `models.py`.
    
4.  Create a default admin user with the credentials: `admin`/`admin`.
    
5.  Create a `nexus.conf` file and populate it with a `[nexus_auth]` section (for scripts to authenticate against the API) and placeholders for Datto/Freshservice credentials.
    

### **4. Generate SSL Certificates**

For secure local development over HTTPS, generate a self-signed certificate.

```
python gen_certs.py

```

This creates a `certs` directory with `cert.pem` and `key.pem` files.

### **5. Configure the Application**

Edit the `instance/nexus.conf` file with your Datto RMM and Freshservice API credentials. The `[nexus_auth]` section is pre-filled with the default admin credentials for the sync scripts.

### **6. Run the Application**

Start the Flask development server.

```
python main.py

```

The application will be available at `https://127.0.0.1:5000`. Your browser will display a security warning because the certificate is self-signed; you can safely proceed.

## **Usage**

### **Web Interface**

-   Navigate to `https://127.0.0.1:5000` in your browser.
    
-   Log in with the admin credentials (`admin/admin`).
    
-   The "Settings" page allows you to manage users (Admin, Technician, Client roles) and scheduler jobs.
    

### **Scheduler**

The application includes a scheduler that runs background jobs to synchronize data. These scripts now authenticate using the credentials specified in the `[nexus_auth]` section of `nexus.conf` to get a JWT.

### **API Endpoints**

The API uses JWT for authentication. Other microservices (like the billing module) must first obtain a token and then use it for all subsequent requests.

#### **Authentication**

-   `POST /api/token`: Authenticate with a `username` and `password` in the JSON body to receive a temporary JWT.
    

#### **Making Authenticated Requests**

All other API endpoints require the JWT to be included in the `Authorization` header.

**Example Header:**  `Authorization: Bearer <your_jwt_here>`

#### **Companies**

-   `GET /api/companies`: Get a list of all companies (`admin`, `technician`).
    
-   `POST /api/companies`: Create a new company (`admin`, `technician`).
    
-   `GET /api/companies/<account_number>`: Get details for a specific company (`admin`, `technician`, or `client` of that company).
    
-   `PUT /api/companies/<account_number>`: Update a specific company (`admin`, `technician`).
    
-   `GET /api/companies/<account_number>/users`: Get all users for a company (`admin`, `technician`, or `client` of that company).
    

#### **Assets**

-   `GET /api/assets`: Get a list of all assets (`admin`, `technician`).
    
-   `POST /api/assets`: Create a new asset (`admin`, `technician`).
    
-   `PUT /api/assets/<asset_id>`: Update a specific asset (`admin`, `technician`).
    

#### **Contacts**

-   `GET /api/contacts`: Get a list of all contacts (`admin`, `technician`).
    
-   `POST /api/contacts`: Create a new contact (`admin`, `technician`).
    
-   `PUT /api/contacts/<contact_id>`: Update a specific contact (`admin`, `technician`).
    

#### **Users**

-   `GET /api/users`: Get a list of all users (`admin` only).
    
-   `GET /api/users/<user_id>`: Get details for a specific user (`admin` only).
