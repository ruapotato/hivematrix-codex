
# Nexus - Client Database Service

Nexus is the central service for managing companies, contacts, assets, and users within the HiveMatrix PSA ecosystem. It provides a web interface for data entry, a scheduler for automated data synchronization, and a set of REST APIs for other microservices to consume.

## Project Structure

```
.
├── main.py                     # Main Flask application file
├── init_db.py                  # Database initialization script
├── scheduler.py                # Scheduler script for running background jobs
├── gen_certs.py                # Script to generate self-signed SSL certs for HTTPS
├── decorators.py               # Custom decorators for authentication and authorization
├── extensions.py               # Flask extension initializations
├── models.py                   # SQLAlchemy database models
├── pull_datto.py               # Script to pull data from Datto RMM
├── pull_freshservice.py        # Script to pull data from Freshservice
├── requirements.txt            # Python dependencies
├── certs/
│   ├── cert.pem                # SSL Certificate (generated by gen_certs.py)
│   └── key.pem                 # SSL Private Key (generated by gen_certs.py)
├── instance/
│   └── nexus.conf              # Configuration file (created on first run)
├── routes/
│   ├── assets.py
│   ├── companies.py
│   ├── contacts.py
│   ├── settings.py
│   └── users.py
└── templates/
    ├── base.html
    ├── login.html
    ├── dashboard.html
    └── ... (other HTML templates)

```

## Setup and Installation

Follow these steps to get the Nexus service running locally.

### 1. Create a Virtual Environment

It's recommended to use a virtual environment to manage project dependencies.

```bash
# For Linux/macOS
python3 -m venv venv
source venv/bin/activate

# For Windows
python -m venv venv
.\venv\Scripts\activate

```


### 2. Install Dependencies

Install the required Python packages using pip.

bash

```bash
pip install -r requirements.txt
```

### 3. Set up PostgreSQL

#### Install PostgreSQL on Ubuntu

First, install PostgreSQL and its additional components:

bash

```bash
# Update package list
sudo apt update

# Install PostgreSQL and additional components
sudo apt install postgresql postgresql-contrib

# Start and enable PostgreSQL service
sudo systemctl start postgresql
sudo systemctl enable postgresql
```

#### Configure PostgreSQL

Switch to the PostgreSQL user and access the PostgreSQL prompt:

```bash
# Switch to postgres user
sudo -i -u postgres

# Access PostgreSQL prompt
psql
```

Create a new database and user for the Nexus application:
```sql
-- Create user with password
CREATE USER nexus_user WITH PASSWORD 'your_secure_password';

CREATE DATABASE nexus_db OWNER nexus_user;

-- Exit PostgreSQL prompt
\q
```

Exit back to your regular user:

```bash
# Exit postgres user session
exit
```

#### Verify Installation

Test the connection with your new user:
```bash
# Test connection (you'll be prompted for the password)
psql -h localhost -U nexus_user -d nexus_db
```

If successful, you should see the PostgreSQL prompt. Type `\q` to exit.

### 4. Initialize the Application

The first time you run the application, you need to create the configuration file and initialize the database schema.

```bash
python init_db.py

```

This command will:

1.  Create the `instance` folder if it doesn't exist.
2.  Create a `nexus.conf` file with placeholder configurations.
3.  Connect to the PostgreSQL database (as prompted) and create the necessary tables.
4.  Create a default admin user with the credentials: `admin`/`admin`.

### 5. Configure the Application
<!--  -->
Edit the newly created `instance/nexus.conf` file. Fill in your Datto RMM and Freshservice API credentials in their respective sections.

```ini
[database]
connection_string = postgresql://nexus_user:your_secure_password@localhost/nexus_db

[nexus_auth]
username = admin
password = admin

[freshservice]
api_key = YOUR_FRESHSERVICE_API_KEY
domain = your-domain.freshservice.com

[datto]
api_endpoint = https://zinfandel-api.centrastage.net
public_key = YOUR_DATTO_PUBLIC_KEY
secret_key = YOUR_DATTO_SECRET_KEY

```
### **6. Run the Application**

You can run the application in two modes: development and production.

#### **Development Mode**

For debugging, use the `--dev` flag. This will start the standard Flask development server, which provides detailed error pages and automatically reloads the server when you change the code.

```bash
python main.py --dev
```

#### **Production Mode (with Waitress)**
For production or staging, run the application without any flags. This will use the efficient `Waitress` WSGI server. This is also the recommended way to run it for regular use when you are not actively debugging.

Bash

```
python main.py
```
The application will be available on port 5000 of your server's IP address. If you generated SSL certificates, it will use `HTTPS`.

## Usage

### Web Interface

-   Navigate to the application URL in your browser.
-   Log in with the admin credentials (`admin/admin`).
-   The "Settings" page allows you to manage users and scheduler jobs.

### Scheduler

The application includes a scheduler that runs background jobs to synchronize data from external services like Datto and Freshservice. These jobs are configured on the "Settings" page.

### API Endpoints

The API uses JWT for authentication. Other microservices must first obtain a token and then use it for all subsequent requests.

#### Authentication

-   `POST /api/token`: Authenticate with a `username` and `password` in the JSON body to receive a temporary JWT.

#### Making Authenticated Requests

All other API endpoints require the JWT to be included in the `Authorization` header.

**Example Header:** `Authorization: Bearer <your_jwt_here>`

#### Companies

-   `GET /api/companies`: Get a list of all companies (`admin`, `technician`).
-   `POST /api/companies`: Create a new company (`admin`, `technician`).
-   `GET /api/companies/<account_number>`: Get details for a specific company (`admin`, `technician`, or `client` of that company).
-   `PUT /api/companies/<account_number>`: Update a specific company (`admin`, `technician`).
-   `GET /api/companies/<account_number>/users`: Get all users for a company (`admin`, `technician`, or `client` of that company).

#### Assets

-   `GET /api/assets`: Get a list of all assets (`admin`, `technician`).
-   `POST /api/assets`: Create a new asset (`admin`, `technician`).
-   `PUT /api/assets/<asset_id>`: Update a specific asset (`admin`, `technician`).

#### Contacts

-   `GET /api/contacts`: Get a list of all contacts (`admin`, `technician`).
-   `POST /api/contacts`: Create a new contact (`admin`, `technician`).
-   `PUT /api/contacts/<contact_id>`: Update a specific contact (`admin`, `technician`).

#### Users

-   `GET /api/users`: Get a list of all users (`admin` only).
-   `GET /api/users/<user_id>`: Get details for a specific user (`admin` only).
